    <main class="content center">
      <section id="userinfo" class="center">
      </section>
      <section id="passkeys">
        <h3>
          Your registered passkeys:
        </h3>
        <md-list id="list"></md-list>
      </section>
      <p id="message" class="instructions"></p>
      <md-filled-button id="create-passkey" class="hidden">Create a passkey</md-filled-button>
    </main>
    <script type="module">
      import { $, _fetch, loading } from '/client.js';
      import { registerCredential, updateCredential, unregisterCredential } from '/passkeys.js';
      import { html, render } from 'https://unpkg.com/lit-html@2.6.1/lit-html.js?module';

      const aaguids = await fetch('/aaguids.json');
      const icons = await aaguids.json();

      /**
       * Change and update the user's display name.
       */
      async function changeDisplayName(e) {
        const newName = prompt('Enter a new display name', e.target.dataset.displayName);
        if (newName) {
          loading.start();
          await _fetch('/auth/updateDisplayName', { newName });
          loading.stop();
          renderDisplayName();
        }
      }

      /**
       * Render the user's display name.
       */
      async function renderDisplayName() {
        const res = await _fetch('/auth/userinfo');
        render(html`
          <img class="profile-image" src="${res.picture}" width="80" height="80">
          <h2>Hi, ${res.displayName}</h2>
          <div class="display-name">
            <span>${res.username}</span>
            <md-icon-button
              slot="end"
              data-display-name="${res.displayName || res.username }"
              @click="${changeDisplayName}"
              title="Edit your display name">
              <md-icon>edit</md-icon>
            </md-icon-button>
          </div>
        `, $('#userinfo'));
      };

      /**
       * Rename and update the credential name.
       */
      async function rename(e) {
        const { credId, name } = e.target.dataset;
        const newName = prompt('Enter a new credential name.', name);
        if (newName.length === 0) return;
        try {
          loading.start();
          await updateCredential(credId, newName);
          await renderCredentials();
          loading.stop();
        } catch (e) {
          loading.stop();
          console.error(e);
          alert(e.message);
        }
      };

      /**
       * Remove and delete a credential.
       */
      async function remove(e) {
        if (!confirm('Do you really want to remove this credential?')) return;

        try {
          loading.start();
          await unregisterCredential(e.target.dataset.credId);
          await renderCredentials();
          loading.stop();
        } catch (e) {
          loading.stop();
          console.error(e);
          alert(e.message);
        }
      };

      const createPasskey = $('#create-passkey');

     // Is WebAuthn available on this browser?
      if (window.PublicKeyCredential &&
          PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable &&
          PublicKeyCredential.isConditionalMediationAvailable) {
        try {
          // Are UVPAA and conditional UI available on this browser?
          const results = await Promise.all([
            PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable(),
            PublicKeyCredential.isConditionalMediationAvailable()
          ]);
          if (results.every(r => r === true)) {
            // If both are available, reveal the "Create a passkey" button.
            createPasskey.classList.remove('hidden');
          } else {
            // If either is not available, show a message.
            $('#message').innerText = 'This device does not support passkeys.';
          }
        } catch (e) {
          console.error(e);
        }
      } else {
        // If the condition does not match, show a message.
        $('#message').innerText = 'This device does not support passkeys.';
      }

      /**
       * Render the list of saved credentials.
       */
      async function renderCredentials() {
        const res = await _fetch('/webauthn/getKeys');
        const list = $('#list');
        const creds = res.length > 0 ? html`${res.map((cred, i) => {
          const created = new Date(cred.registered);
          const createdDate = created.toLocaleDateString(undefined, {month: 'short', day: 'numeric'});
          const createdTime = created.toLocaleTimeString(undefined, {timeStyle: 'short', hour12: false});
          const createdStr = `Created: ${createdDate}, ${createdTime}`;
          return html`${i > 0 && i < res.length ? html`
          <md-divider></md-divider>
          `:''}
          <md-list-item>
            <img slot="start" src="${icons[cred.aaguid].icon_light}" title="${icons[cred.aaguid].name}" width="24" height="24">
            <span slot="headline">${cred.name || 'Unnamed' }</span>
            <span slot="supporting-text">${createdStr}</span>
            <md-icon-button
              slot="end"
              data-cred-id="${cred.id}"
              data-name="${cred.name || 'Unnamed' }"
              @click="${rename}">
              <md-icon>edit</md-icon>
            </md-icon-button>
            <md-icon-button
              slot="end"
              data-cred-id="${cred.id}"
              @click="${remove}">
              <md-icon>delete</md-icon>
            </md-icon-button>
          </md-list-item>`;})}`
        : html`<md-list-item>No credentials found.</md-list-item>`;
        render(creds, list);
      };

      /**
       * Create a new paskey and register the credential.
       */
      async function register() {
        try {
          loading.start();
          await registerCredential();
          await renderCredentials();
          loading.stop();
        } catch (e) {
          // Stop the loading UI
          loading.stop();
          // 'InvalidStateError' indicates a passkey already exists on the device.
          if (e.name === 'InvalidStateError') {
            alert('A passkey already exists for this device.');
          // `NotAllowedError` indicates the user canceled the operation.
          } else if (e.name === 'NotAllowedError') {
            return;
          // Show other errors in an alert.
          } else {
            alert(e.message);
            console.error(e);
          }
        }
      };

      loading.start();
      renderDisplayName();
      await renderCredentials();
      loading.stop();

      createPasskey.addEventListener('click', register);
    </script>